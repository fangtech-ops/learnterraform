# 40-eks1-bootstrap <!-- omit in toc -->

<!-- The TOC and section numberings are generated by VS Code extension "Markdown All in One" -->
- [1. How to Run Terraform in This Folder](#1-how-to-run-terraform-in-this-folder)


# 1. How to Run Terraform in This Folder

* **See Also:** [/admin/devops/40-eks1-bootstrap/README.md](https://github.com/narvar/terraform-aws-accounts/tree/main/admin/devops/40-eks1-bootstrap/README.md).

In addition to the above-referenced `devops` account's README, also note the following.

Despite this being the `qa71` account (i.e., the AWS Account that owns the current EKS cluster), we still launch `terraform apply` from the AWS Profile `devops`. The reason is because only the central `devops` account's SSO role (`arn:aws:iam::106628749228:role/aws-reserved/sso.amazonaws.com/us-west-2/AWSReservedSSO_AWSAdministratorAccess_93060f8c67728fb7`) has the (cross-account) privilege to `AssumeRole` to various account's `NarvarTerraformRole` for reading those target accounts' terraform remote state buckets (where the S3 buckets belong to the `networking` account, `dev71` account, etc.)

So, launch terraform in this folder like this:

```console
  ## On laptop (or inside the Docker container https://github.com/narvar/foundation-local-env)


  ## If haven't done so in the past 24 hours, get the old QA account MFA token.
  ## This is the major difference between qa71 (old QA account) and new accounts (AWS Control Tower).
$ mfaqa


  ## If haven't done so in the past 12 hours, login to AWS SSO.
  ## E.g., using the command alias in the Docker container, we'd do:
$ sso


  ## Point to AWS Profile `devops`:
  ##    - either use the command alias 'devops' as we are doing below;
  ##    - or, 'export AWS_PROFILE=devops'
$ devops

  ## Confirm our IAM identity:
$ aws sts get-caller-identity
{
    "UserId": "AR......XP:vincent.yin@narvar.com",
    "Account": "106628749228",                     <=== AWS Account 'devops', not 'qa71'.
    "Arn": "arn:aws:sts::106628749228:assumed-role/AWSReservedSSO_AWSAdministratorAccess_93060f8c67728fb7/vincent.yin@narvar.com"
}


  ## You can confirm mfa_qa AWS profile works by listing s3 buckets:
$ AWS_PROFILE=mfa_qa aws s3 ls

$ cd /GITHUB/terraform-aws-accounts/qa/qa71/40-eks1-bootstrap  # i.e., this folder

  ## Launch terraform (under AWS Profile `devops` -- not `mfa_qa`)
$ terraform apply

  ## This is a quirk (bug?) of the new version 1.x.x of terraform. 
$ terraform apply -refresh-only -auto-approve
```
